#!/bin/sh -eu

if [ $# -ne 2 ]; then
    echo "Usage: $0 <package_name> <package_version>"
    exit 1
fi

set -x

package="$1"
version="$2"
arch="$(uname -m)"
binary_url=""
extract=""

case "${package}" in
mdbook)
    case "${arch}" in
    x86_64)
        binary_url="https://github.com/rust-lang/mdBook/releases/download/v${version}/mdbook-v${version}-${arch}-unknown-linux-gnu.tar.gz"
        extract="mdbook"
        ;;
    esac
    ;;
mdbook-mermaid)
    case "${arch}" in
    x86_64)
        binary_url="https://github.com/badboy/mdbook-mermaid/releases/download/v${version}/mdbook-mermaid-v${version}-${arch}-unknown-linux-gnu.tar.gz"
        extract="mdbook-mermaid"
        ;;
    esac
    ;;
mdbook-linkcheck)
    case "${arch}" in
    x86_64)
        binary_url="https://github.com/Michael-F-Bryan/mdbook-linkcheck/releases/download/v${version}/mdbook-linkcheck.${arch}-unknown-linux-gnu.zip"
        extract="mdbook-linkcheck"
        ;;
    esac
    ;;
esac

case "${binary_url}" in
*.tar.gz)
    curl -L "${binary_url}" > binary.tar.gz
    tar -xzvf binary.tar.gz
    cp "${extract}" /build/bin/
    chmod +x /build/bin/"${extract}"
    ;;
*.zip)
    curl -L "${binary_url}" > binary.zip
    unzip binary.zip
    cp "${extract}" /build/bin/
    chmod +x /build/bin/"${extract}"
    ;;
"")
    cargo install "${package}" --version "${version}" --root /build
    ;;
esac
